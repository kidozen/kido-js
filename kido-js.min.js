// KidoZen Javascript SDK v0.1.3.
// Copyright (c) 2013 Kidozen, Inc. MIT Licensed
jQuery.extend({crossDomain:function(b){var d=$.Deferred();if(!XMLHttpRequest&&!XDomainRequest)throw"Unsupported Browser.";var a=new XMLHttpRequest;if(void 0==a.withCredentials)throw"Browser doesn't support CORS.";a.open(b.type,b.url,!0);a.onreadystatechange=function(){if(4==a.readyState&&200==a.status){var c=null;if(null!=a.responseXML)c=a.responseXML;else if(null!=a.responseText)try{c=JSON.parse(a.responseText)}catch(b){c=a.responseText}d.resolve(c)}};a.send();return d}});var JSON;JSON||(JSON={});
(function(){function b(a){return 10>a?"0"+a:a}function d(a){e.lastIndex=0;return e.test(a)?'"'+a.replace(e,function(a){var c=j[a];return"string"===typeof c?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function a(c,b){var e,j,m,n,p=f,l,h=b[c];h&&("object"===typeof h&&"function"===typeof h.toJSON)&&(h=h.toJSON(c));"function"===typeof k&&(h=k.call(b,c,h));switch(typeof h){case "string":return d(h);case "number":return isFinite(h)?String(h):"null";case "boolean":case "null":return String(h);case "object":if(!h)return"null";
f+=g;l=[];if("[object Array]"===Object.prototype.toString.apply(h)){n=h.length;for(e=0;e<n;e+=1)l[e]=a(e,h)||"null";m=0===l.length?"[]":f?"[\n"+f+l.join(",\n"+f)+"\n"+p+"]":"["+l.join(",")+"]";f=p;return m}if(k&&"object"===typeof k){n=k.length;for(e=0;e<n;e+=1)"string"===typeof k[e]&&(j=k[e],(m=a(j,h))&&l.push(d(j)+(f?": ":":")+m))}else for(j in h)Object.prototype.hasOwnProperty.call(h,j)&&(m=a(j,h))&&l.push(d(j)+(f?": ":":")+m);m=0===l.length?"{}":f?"{\n"+f+l.join(",\n"+f)+"\n"+p+"}":"{"+l.join(",")+
"}";f=p;return m}}"function"!==typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+b(this.getUTCMonth()+1)+"-"+b(this.getUTCDate())+"T"+b(this.getUTCHours())+":"+b(this.getUTCMinutes())+":"+b(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var c=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
e=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,f,g,j={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},k;"function"!==typeof JSON.stringify&&(JSON.stringify=function(c,d,b){var e;g=f="";if("number"===typeof b)for(e=0;e<b;e+=1)g+=" ";else"string"===typeof b&&(g=b);if((k=d)&&"function"!==typeof d&&("object"!==typeof d||"number"!==typeof d.length))throw Error("JSON.stringify");return a("",{"":c})});
"function"!==typeof JSON.parse&&(JSON.parse=function(a,d){function b(a,c){var e,f,g=a[c];if(g&&"object"===typeof g)for(e in g)Object.prototype.hasOwnProperty.call(g,e)&&(f=b(g,e),void 0!==f?g[e]=f:delete g[e]);return d.call(a,c,g)}var e;a=String(a);c.lastIndex=0;c.test(a)&&(a=a.replace(c,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return e=eval("("+a+")"),"function"===typeof d?b({"":e},""):e;throw new SyntaxError("JSON.parse");})})();wsTrustClient=function(b){this.requestToken=function(d){d='<s:Envelope xmlns:s="http://www.w3.org/2003/05/soap-envelope" xmlns:a="http://www.w3.org/2005/08/addressing" xmlns:u="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"><s:Header><a:Action s:mustUnderstand="1">http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue</a:Action><a:To s:mustUnderstand="1">[To]</a:To><o:Security s:mustUnderstand="1" xmlns:o="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd"><o:UsernameToken u:Id="uuid-6a13a244-dac6-42c1-84c5-cbb345b0c4c4-1"><o:Username>[Username]</o:Username><o:Password Type="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-username-token-profile-1.0#PasswordText">[Password]</o:Password></o:UsernameToken></o:Security></s:Header><s:Body><trust:RequestSecurityToken xmlns:trust="http://docs.oasis-open.org/ws-sx/ws-trust/200512"><wsp:AppliesTo xmlns:wsp="http://schemas.xmlsoap.org/ws/2004/09/policy"><a:EndpointReference><a:Address>[ApplyTo]</a:Address></a:EndpointReference></wsp:AppliesTo><trust:KeyType>http://docs.oasis-open.org/ws-sx/ws-trust/200512/Bearer</trust:KeyType><trust:RequestType>http://docs.oasis-open.org/ws-sx/ws-trust/200512/Issue</trust:RequestType><trust:TokenType>urn:oasis:names:tc:SAML:2.0:assertion</trust:TokenType></trust:RequestSecurityToken></s:Body></s:Envelope>'.replace("[To]",
b).replace("[Username]",d.username).replace("[Password]",d.password).replace("[ApplyTo]",d.scope);return $.ajax({dataType:"XML",crossDomain:!0,url:b,type:"POST",data:d,headers:{"Content-Type":"application/soap+xml; charset=utf-8","Content-Length":d.length}})}};var Kido=function(){var b=this;if(!(this instanceof Kido))return new Kido;this.name="local";this.send=function(d){d.url=d.url;d=$.extend({url:"",type:"POST",cache:!0},d);!d.contentType&&d.data&&(d.contentType="application/json");return!d.url?$.Deferred().reject({msg:"Not a valid ajax URL.",error:"Invalid URL"}):$.ajax(d)};this.get=function(d,a){a=$.extend({url:d,type:"GET"},a||{});return b.send(a)};this.post=function(d,a,c){c=$.extend({url:d,type:"POST",data:a?JSON.stringify(a):null},c||{});return b.send(c)};
this.del=function(d,a){a=$.extend({url:d,type:"DELETE"},a||{});return b.send(a)}};var KidoConfig=function(b){var d=this;if(!(this instanceof KidoConfig))return new KidoConfig(b);if(!b)throw"The 'kidoApp' argument is required by the KidoConfig class.";this.app=b;this.set=function(a,c){if(!a)throw"The config key 'name' is required to set a value.";return d.app.post("/config/"+a,c)};this.get=function(a){if(!a)throw"The config key 'name' is required to retrieve the value.";return d.app.get("/config/"+a)};this.getAll=function(){return d.app.get("/config")};this.del=function(a){if(!a)throw"The config key 'name' is required to delete a value.";
return d.app.del("/config/"+a)}};Kido.prototype.config=function(){this._config||(this._config=new KidoConfig(this));return this._config};var KidoEmail=function(b){var d=this;if(!(this instanceof KidoEmail))return new KidoEmail(b);if(!b)throw"The 'kidoApp' argument is required by the KidoEmail class.";this.app=b;this.send=function(a,c,e,b,g){if(!c)throw"The 'to' argument is required to send an email.";if(!a)throw"The 'from' argument is required to send an email.";a={to:c,from:a};"string"===typeof e&&0<e.length&&(a.subject=e);"string"===typeof b&&0<b.length&&(a.bodyText=b);"string"===typeof g&&0<g.length&&(a.bodyHtml=g);return d.app.send({url:"/email",
type:"POST",data:JSON.stringify(a)})}};Kido.prototype.email=function(){this._email||(this._email=new KidoEmail(this));return this._email};var KidoLogging=function(b){var d=this;if(!(this instanceof KidoLogging))return new KidoLogging(b);if(!b)throw"The 'kidoApp' argument is required by the KidoLogging class.";this.app=b;this.writeVerbose=function(a){return this.write(a,0)};this.writeInfo=function(a){return this.write(a,1)};this.writeWarning=function(a){return this.write(a,2)};this.writeError=function(a){return this.write(a,3)};this.writeCritical=function(a){return this.write(a,4)};this.write=function(a,c){if(!a)throw"'data' argument is requiered.";
if(!c&&0!==c)throw"'level' argument is required.";if(!(0<=c&&4>=c))throw"'level' argument must be an integer number between 0 and 4.";return d.app.send({url:"/logging?level="+c,type:"POST",data:JSON.stringify(a)})};this.query=function(a,c){var b=[];a&&b.push("query="+JSON.stringify(a));c&&b.push("options="+JSON.stringify(c));return d.app.send({url:"/logging"+(0<b.length?"?"+b.join("&"):""),type:"GET"})};this.get=function(a,c,b,f){var g={};c&&(g.level=c);if(a){if(!(a instanceof Date))throw"'Since' argument accepts only null or Date values.";
g.dateTime={$gt:a}}else g.dateTime={$exists:!0};a={$sort:{dateTime:-1}};b&&(a.$skip=b);f&&(a.$limit=f);return d.query(g,a)};this.clear=function(){return d.app.send({url:"/logging",type:"DELETE",dataType:"text"})}};Kido.prototype.logging=function(){this._logging||(this._logging=new KidoLogging(this));return this._logging};var KidoNotifications=function(b){if(!(this instanceof KidoNotifications))return new KidoNotifications(b);if(!b)throw"The 'kidoApp' argument is required by the KidoNotifications class.";this.app=b;this.send=function(b,a,c,e,f,g,j){if(!b)throw"'channel' argument is required.";if(!a)throw"'title' argument is required.";a={title:a};"string"===typeof e&&e&&(a.type=e);"string"===typeof c&&c&&(a.text=c);"string"===typeof g&&g&&(a.image=g);"number"===typeof f&&(a.badge=f);j&&(a.param=j);return parentKido.send({url:"/notifications/push/"+
parentKido.applicationName+"/"+b,type:"POST",data:JSON.stringify(a)})}};Kido.prototype.notifications=function(){this._notifications||(this._notifications=new KidoNotifications(this));return this._notifications};var KidoPubsub=function(b){var d=this;if(!(this instanceof KidoPubsub))return new KidoPubsub(b);if(!b)throw"The 'kidoApp' argument is required by the KidoPubsub class.";this.app=b;this.channel=function(a){return new KidoPubsubChannel(a,d.app)}},KidoPubsubChannel=function(b,d){var a=this;this.name=b;this.app=d;this.publish=function(c){return a.app.send({url:"/pubsub/"+a.app.name+"/"+a.name,type:"POST",data:JSON.stringify(c),dataType:"text"})};this.subscribe=function(c){var b=io.connect("/pubsub");
b.on("connect",function(){b.emit("bindToChannel",{application:a.app.name,channel:a.name})});b.on("bindAccepted",function(a){b.on(a.responseChannelName,c)});return function(){b.disconnect()}}};Kido.prototype.pubsub=function(){this._pubsub||(this._pubsub=new KidoPubsub(this));return this._pubsub};var KidoQueues=function(b){var d=this;if(!(this instanceof KidoQueues))return new KidoQueues(b);if(!b)throw"The 'kidoApp' argument is required by the KidoQueues class.";this.app=b;this.queue=function(a){return{push:function(c){c={url:"/queue/"+d.app.name+"/"+a,type:"POST",data:JSON.stringify(c),dataType:"text"};return d.app.send(c)},dequeue:function(){return d.app.send({url:"/queue/"+d.app.name+"/"+a+"/next",type:"DELETE"})}}}};
Kido.prototype.queues=function(){this._queues||(this._queues=new KidoQueues(this));return this._queues};var KidoSecurity=function(b){var d=this;if(!(this instanceof KidoSecurity))return new KidoSecurity(b);if(!b)throw"The 'kidoApp' argument is required by the KidoSecurity class.";this.app=b;this.getLoggedInUser=function(){return d.app.get("/user")};this.getOriginalToken=function(){return d.app.get("/user/original-token")}};Kido.prototype.security=function(){this._security||(this._security=new KidoSecurity(this));return this._security};var KidoSms=function(b){var d=this;if(!(this instanceof KidoSms))return new KidoSms(b);if(!b)throw"The 'kidoApp' argument is required by the KidoSms class.";this.app=b;this.send=function(a,c){return d.app.post({url:"/sms?to="+encodeURIComponent(a)+"&message="+encodeURIComponent(c),headers:{"Content-Length":0}})};this.getStatus=function(a){return d.app.get("/sms/"+a)}};Kido.prototype.sms=function(){this._sms||(this._sms=new KidoSms(this));return this._sms};var KidoStorage=function(b){var d=this;if(!(this instanceof KidoStorage))return new KidoStorage(b);this.app=b;this.rootUrl="/storage/"+this.app.name;this.getObjectSetNames=function(){return d.app.get(d.rootUrl)};this.objectSet=function(a){return new KidoObjectSet(a,this)}},KidoObjectSet=function(b,d){var a=this;if(!(this instanceof KidoObjectSet))return new KidoObjectSet(b,d);if(!d)throw"KidoObjectSet needs a parent KidoStorage object.";this.storage=d;this.name=b||"default";this.rootUrl=this.storage.rootUrl+
"/"+this.name;this.invoke=function(c){if(!c)throw"The storage 'data' argument is required";if(!c.settings)throw"The storage 'data.settings' property is required.";var b=[];c.query&&b.push("query="+JSON.stringify(c.query));c.options&&b.push("options="+JSON.stringify(c.options));c.fields&&b.push("fields="+JSON.stringify(c.fields));c.isPrivate&&b.push("isPrivate=true");c.settings.url=a.rootUrl+(c.objectId?"/"+c.objectId:"")+(c.indexes?"/"+c.indexes:"")+(b.length?"?"+b.join("&"):"");c.settings.url=encodeURI(c.settings.url);
c.settings.cache=c.cache;return a.storage.app.send(c.settings)};this.insert=function(c,b){if(!c)throw"The object set 'obj' argument is requiered in order to insert.";c=$.extend({},c);c._id=void 0;var d={settings:{type:"POST",data:JSON.stringify(c)},isPrivate:b};return a.invoke(d).pipe(function(a){return $.extend(c,a)})};this.update=function(c,b){if(!c)throw"obj argument is requiered.";c=$.extend({},c);var d={settings:{type:"PUT",data:JSON.stringify(c)},isPrivate:!!b};return a.invoke(d).pipe(function(a){return $.extend(c,
a)},function(a){if(409===a.status)try{a.body=JSON.parse(a.responseText)}catch(c){}return a})};this.save=function(c,b){if(!c)throw"obj argument is requiered.";c=$.extend({},c);return c._id&&0<c._id.length?a.update(c,b):a.insert(c,b)};this.get=function(b){if(!b)throw"objectId is required";var d=$.Deferred();a.invoke({settings:{type:"GET"},objectId:b,cache:!1}).fail(function(a){404===a.status?d.resolve(null):d.reject(a)}).done(function(a){d.resolve(a)});return d};this.query=function(b,d,f,g){return a.invoke({settings:{type:"GET"},
query:b,fields:d,options:f,cache:g})};this.del=function(b){return a.invoke({settings:{type:"DELETE",dataType:"text"},objectId:b})};this.drop=function(){return a.invoke({settings:{type:"DELETE",dataType:"text"}})}};Kido.prototype.storage=function(){this._storage||(this._storage=new KidoStorage(this));return this._storage};var KidoStorageIndexes=function(b){var d=this;if(!(this instanceof KidoStorageIndexes))return new KidoStorageIndexes(b);if(!b)throw"The 'objectSet' argument is required by the KidoStorageIndexes class.";this.objectSet=b;this.all=function(){return d.objectSet.invoke({indexes:"indexes",settings:{type:"GET"}})};this.get=function(a){if(!a)throw"The 'name' argument is required to retrieve an object set index.";return d.objectSet.invoke({indexes:"indexes?name="+a,settings:{type:"GET"}})};this.del=function(a){if(!a)throw"The 'name' argument is required to delete an object set index.";
return d.objectSet.invoke({indexes:"indexes/"+a,settings:{type:"DELETE"}})};this.create=function(a,b,e,f,g,j,k,q){if(!a)throw"The 'spec' argument is required to create an index.";b||(b=!1);e||(e=!1);f||(f=!1);g||(g=!1);j||(j=!1);a={spec:a,options:{safe:b,unique:e,sparse:f,background:g,dropDups:j}};k&&"0"!=k.toString()&&(a.options.min=k);q&&"0"!=q.toString()&&(a.options.max=q);k={indexes:"indexes",settings:{type:"POST",data:JSON.stringify(a)}};return d.objectSet.invoke(k)}};
KidoObjectSet.prototype.indexes=function(){this._indexes||(this._indexes=new KidoStorageIndexes(this));return this._indexes};var KidoService=function(b,d){var a=this;if(!(this instanceof KidoService))return new KidoService(b);if(!b)throw"The 'kidoApp' argument is required by the KidoService class.";this.app=b;this.name=d;this._defaults={};this.defaults=function(b){a._defaults=$.extend(a._defaults,b||{});return a};this.invoke=function(b,d){var f=$.Deferred(),g=$.extend({},a._defaults,d);a.app.post("/api/services/"+a.name+"/invoke/"+b,g).done(function(a){if(a.error)return f.reject(a.error);f.resolve(a.data||a)}).fail(function(a){f.reject(a)});
return f}};Kido.prototype.services=function(b){return new KidoService(this,b)};
