// KidoZen Javascript SDK v0.1.5.
// Copyright (c) 2013 Kidozen, Inc. MIT Licensed
if(!JSON||!JSON.parse||!JSON.stringify)throw"KidoZen requires JSON.stringify. Try adding a polyfil lib like json2.js";
var Kido=function(d,e){function b(b){if("undefined"===typeof b.kidoService||!b.kidoService.caching)return $.ajax(b);var c=b.data,a=b.kidoService.service,g=b.kidoService.collection,f=b.kidoService.objectId,e=b.kidoService.query,l=b.type.toLowerCase(),d=h.localStorage().collection(a+"."+g),k="get"===l&&f,q="get"===l&&!f,u="post"===l&&c,m="put"===l&&c,n="delete"===l&&f,r="delete"===l&&!f,s=(a=c?JSON.parse(c):null)?a._id:null;if(f&&0>parseInt(f)||s&&0>parseInt(s)){if(k)return d.get(f);if(n)return d.del(f).then(function(){return d.localStorage.removePendingRequest(f)});
m&&(b.type="POST",delete a._id,b.data=JSON.stringify(a),f=null)}var p=$.Deferred();d.localStorage.executePendingRequests().always(function(){var a=$.ajax(b);q||u||m?a.then(function(b){return d.persist(b)}):n?a.then(function(){return d.del(f?f:s)}):r&&a.then(function(){return d.drop()});a.fail(function(a){if(0!==a.status)return p.reject(a);a=function(a){if(u||m||n||r){var c=r?(-1*$.now()).toString():n?f:m?s:a._id;d.localStorage.addPendingRequest(c,b).then(function(){p.resolve(a)})}else p.resolve(a)};
q?d.query(e).then(a):k?d.get(f).then(a):u||m?d.persist(c).then(a):n?d.del(f).then(a):r&&d.drop().then(a)});a.done(function(a){p.resolve(a)})});return p.promise()}function c(a){return $.ajax({dataType:"text",crossDomain:!0,url:a.endpoint,type:"POST",data:'<s:Envelope xmlns:s="http://www.w3.org/2003/05/soap-envelope" xmlns:a="http://www.w3.org/2005/08/addressing" xmlns:u="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"><s:Header><a:Action s:mustUnderstand="1">http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue</a:Action><a:To s:mustUnderstand="1">[To]</a:To><o:Security s:mustUnderstand="1" xmlns:o="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd"><o:UsernameToken u:Id="uuid-6a13a244-dac6-42c1-84c5-cbb345b0c4c4-1"><o:Username>[Username]</o:Username><o:Password Type="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-username-token-profile-1.0#PasswordText">[Password]</o:Password></o:UsernameToken></o:Security></s:Header><s:Body><trust:RequestSecurityToken xmlns:trust="http://docs.oasis-open.org/ws-sx/ws-trust/200512"><wsp:AppliesTo xmlns:wsp="http://schemas.xmlsoap.org/ws/2004/09/policy"><a:EndpointReference><a:Address>[ApplyTo]</a:Address></a:EndpointReference></wsp:AppliesTo><trust:KeyType>http://docs.oasis-open.org/ws-sx/ws-trust/200512/Bearer</trust:KeyType><trust:RequestType>http://docs.oasis-open.org/ws-sx/ws-trust/200512/Issue</trust:RequestType><trust:TokenType>urn:oasis:names:tc:SAML:2.0:assertion</trust:TokenType></trust:RequestSecurityToken></s:Body></s:Envelope>'.replace("[To]",
a.endpoint).replace("[Username]",a.user).replace("[Password]",a.pass).replace("[ApplyTo]",a.scope),headers:{"Content-Type":"application/soap+xml; charset=utf-8"}})}function a(a){return $.ajax({url:a.endpoint,data:{wrap_name:a.user,wrap_password:a.pass,wrap_scope:a.scope},type:"POST",dataType:"text"})}function g(a){if(!a.signInUrl)return $.Deferred().reject("Passive Authentication not supported.");if("undefined"===typeof window.atob)return $.Deferred().reject("Browser does not support window.atob()");
var b=$.Deferred(),c=window.open(a.signInUrl,"_blank","location=yes");c.addEventListener("loadstop",function(a){c.executeScript({code:"document.title;"},function(a){a=a[0];if(-1!==a.indexOf("Success payload=")){c.close();a=JSON.parse(window.atob(a.replace("Success payload=","")));if(!a||!a.access_token)return b.reject("Unable to retrieve KidoZen token.");b.resolve(l(a))}})});return b.promise()}function f(b,g,f,d,e){var t;if("wrapv0.9"===e.protocol.toLowerCase())t=a;else if("ws-trust"===e.protocol.toLowerCase())t=
c;else return $.Deferred().reject("Protocol not supported yet.");return t({user:g,pass:f,scope:b.authServiceScope,endpoint:e.endpoint}).then(function(a){return(a=(/<Assertion(.*)<\/Assertion>/.exec(a)||[])[0])?$.ajax({url:b.authServiceEndpoint,type:"POST",data:{wrap_assertion:a,wrap_scope:b.applicationScope,wrap_assertion_format:"SAML"}}).then(function(a){if(!a||!a.access_token)return $.Deferred().reject("Unable to retrieve KidoZen token.");h.authenticated=!0;k=g;q=f;v=d;return l(a)}):$.Deferred().reject("Unable to get a token from IDP")})}
function l(a){a.token='WRAP access_token="'+a.access_token+'"';var b=decodeURIComponent(a.access_token).split("&");a.claims=b;for(var c in b){var g=b[c];if(-1<g.indexOf("ExpiresOn")){a.expiresOn=1E3*~~g.split("=")[1]-2E4;break}}return a}if(!(this instanceof Kido))return new Kido;if("undefined"!==typeof e)if(-1===e.indexOf("://"))e="https://"+e;else if(0!==e.indexOf("http://")&&0!==e.indexOf("https://"))throw"Marketplace url must begin with https://";var h=this,k=null,q=null,v=null;this.name=d||"local";
this.marketplace=e;this.local="local"===this.name;this.authenticated=(this.hosted=!e)?!0:!1;this.hosted||(this.authConfig=$.ajax({url:this.marketplace+"/publicapi/apps?name="+this.name}).then(function(a){if(!a||!a.length)return $.Deferred().reject("Application configuration not found.");h.url=a[0].url.substring(0,a[0].url.length-1);return a[0].authConfig},function(){return $.Deferred().reject("Unable to retrieve application configuration. Either there is no internet connection or the marketplace url is invalid.")}));
this.authenticate=function(){if(this.hosted)return $.Deferred().reject("No need to authenticate to this Web App");var a=arguments;return this.token=this.authConfig.then(function(b){if(0===a.length)return g(b);var c=b.identityProviders,d=a[2]||Object.keys(c)[0];return(c=c[d])?c.protocol?f(b,a[0],a[1],a[2],c):$.Deferred().reject("Invalid Identity Provider Protocol"):$.Deferred().reject("Invalid Identity Provider")})};this.send=function(a){if(!a.url)return $.Deferred().reject({msg:"Not a valid ajax URL.",
error:"Invalid URL"});var c=$.extend({},{type:"POST",cache:!0},a);c.data&&!c.contentType&&(c.contentType="application/json");return!h.hosted&&h.authenticated?h.token.then(function(a){return a.expiresOn<(new Date).getTime()?h.authenticate(k,q,v):a}).then(function(a){c.url=h.url+c.url;c.headers=c.headers||{};c.headers.authorization=a.token;return b(c)}):b(c)};this.get=function(a,b){b=$.extend({url:a,type:"GET"},b||{});return h.send(b)};this.post=function(a,b,c){c=$.extend({url:a,type:"POST",data:b?
JSON.stringify(b):null},c||{});return h.send(c)};this.del=function(a,b){b=$.extend({url:a,type:"DELETE"},b||{});return h.send(b)}};var KidoConfig=function(d){var e=this;if(!(this instanceof KidoConfig))return new KidoConfig(d);if(!d)throw"The 'kidoApp' argument is required by the KidoConfig class.";this.app=d;this.set=function(b,c){if(!b)throw"The config key 'name' is required to set a value.";return e.app.post("/config/"+b,c)};this.get=function(b){if(!b)throw"The config key 'name' is required to retrieve the value.";return e.app.get("/config/"+b)};this.getAll=function(){return e.app.get("/config")};this.del=function(b){if(!b)throw"The config key 'name' is required to delete a value.";
return e.app.del("/config/"+b)}};Kido.prototype.config=function(){this._config||(this._config=new KidoConfig(this));return this._config};var KidoEmail=function(d){var e=this;if(!(this instanceof KidoEmail))return new KidoEmail(d);if(!d)throw"The 'kidoApp' argument is required by the KidoEmail class.";this.app=d;this.send=function(b,c,a,g,f,d,h){if(b&&"object"===typeof b){var k=b;b=k.from;c=k.to;a=k.subject;g=k.bodyText;f=k.bodyHtml;d=k.attachments;h=k.timeout}if(!b)throw"The 'from' argument is required to send an email.";if(!c)throw"The 'to' argument is required to send an email.";!d&&f instanceof Array&&(d=f,f=null);k={to:c,from:b};
"string"===typeof a&&0<a.length&&(k.subject=a);"string"===typeof g&&0<g.length&&(k.bodyText=g);"string"===typeof f&&0<f.length&&(k.bodyHtml=f);d instanceof Array&&(k.attachments=d);return e.app.send({url:"/email",type:"POST",data:JSON.stringify(k),timeout:h||9E5})};this.attach=function(b,c,a){b instanceof HTMLFormElement&&(b=new FormData(b));if(b instanceof HTMLInputElement){if(!b.type||"file"!==b.type.toLowerCase())throw"HTML Input element must be of type 'file'.";b=b.files[0]}if(b instanceof File){var g=
b;b=new FormData;b.append(g.name,g)}if(b instanceof FormData)"function"===typeof c&&(a=c,c=null);else if("string"===typeof b){g=b;b=new FormData;if(!c||"function"===typeof c)throw"if a name was specified, 'data' argument is required.";"string"===typeof c&&(c=new Blob([c],{type:"text/text"}));if(!(c instanceof Blob))throw"'data' argument must be a string, a Blob instance or a File instance.";b.append(g,c,g)}else throw"The argument 'formOrName' is invalid.";var f=new jQuery.Deferred;c=function(a){f.reject(a.currentTarget)};
g=new XMLHttpRequest;g.upload&&"function"===typeof a&&g.upload.addEventListener("progress",a,!1);g.addEventListener("load",function(a){f.resolve(JSON.parse(a.currentTarget.response))},!1);g.addEventListener("error",c,!1);g.addEventListener("abort",c,!1);g.open("POST","/email/attachments");g.send(b);return f.promise()}};Kido.prototype.email=function(){this._email||(this._email=new KidoEmail(this));return this._email};var KidoLogging=function(d){var e=this;if(!(this instanceof KidoLogging))return new KidoLogging(d);if(!d)throw"The 'kidoApp' argument is required by the KidoLogging class.";this.app=d;this.writeVerbose=function(b){return e.write(b,0)};this.writeInfo=function(b){return e.write(b,1)};this.writeWarning=function(b){return e.write(b,2)};this.writeError=function(b){return e.write(b,3)};this.writeCritical=function(b){return e.write(b,4)};this.write=function(b,c){if(!b)throw"'data' argument is requiered.";
if(!c&&0!==c)throw"'level' argument is required.";if(!(0<=c&&4>=c))throw"'level' argument must be an integer number between 0 and 4.";return e.app.send({url:"/logging?level="+c,type:"POST",data:JSON.stringify(b)})};this.query=function(b,c){var a=[];b&&a.push("query="+JSON.stringify(b));c&&a.push("options="+JSON.stringify(c));return e.app.send({url:"/logging"+(0<a.length?"?"+a.join("&"):""),type:"GET"})};this.get=function(b,c,a,g){var f={};c&&(f.level=c);if(b){if(!(b instanceof Date))throw"'Since' argument accepts only null or Date values.";
f.dateTime={$gt:b}}else f.dateTime={$exists:!0};b={$sort:{dateTime:-1}};a&&(b.$skip=a);g&&(b.$limit=g);return e.query(f,b)};this.clear=function(){return e.app.send({url:"/logging",type:"DELETE",dataType:"text"})}};Kido.prototype.logging=function(){this._logging||(this._logging=new KidoLogging(this));return this._logging};var KidoNotifications=function(d){var e=this;if(!(this instanceof KidoNotifications))return new KidoNotifications(d);if(!d)throw"The 'kidoApp' argument is required by the KidoNotifications class.";this.app=d;this.send=function(b,c,a,g,f,d,h){if(!b)throw"'channel' argument is required.";if(!c)throw"'title' argument is required.";c={title:c};"string"===typeof g&&g&&(c.type=g);"string"===typeof a&&a&&(c.text=a);"string"===typeof d&&d&&(c.image=d);"number"===typeof f&&(c.badge=f);h&&(c.param=h);return e.app.send({url:"/notifications/push/local/"+
b,type:"POST",data:JSON.stringify(c)})};this.subscribe=function(b,c,a,g){if(!b)throw"'deviceId' argument is required.";if(!c)throw"'channel' argument is required.";if(!a)throw"'subscriptionId' argument is required.";if(!g)throw"'platform' is required. Use one of: gcm, apns, c2dm, mpns or wns.";return e.app.send({url:"/notifications/subscriptions/local/"+c,type:"POST",data:JSON.stringify({deviceId:b,subscriptionId:a,platform:g})})}};
Kido.prototype.notifications=function(){this._notifications||(this._notifications=new KidoNotifications(this));return this._notifications};var KidoPubsub=function(d){var e=this;if(!(this instanceof KidoPubsub))return new KidoPubsub(d);if(!d)throw"The 'kidoApp' argument is required by the KidoPubsub class.";this.app=d;this.channel=function(b){return new KidoPubsubChannel(b,e.app)}},KidoPubsubChannel=function(d,e){var b=this;this.name=d;this.app=e;this.rootUrl="/pubsub/local/";this.publish=function(c){return b.app.send({url:b.rootUrl+b.name,type:"POST",data:JSON.stringify(c),dataType:"text"})};this.subscribe=function(c){var a=io.connect("/pubsub");
a.on("connect",function(){a.emit("bindToChannel",{application:b.app.name,channel:b.name})});a.on("bindAccepted",function(b){a.on(b.responseChannelName,c)});return function(){a.disconnect()}}};Kido.prototype.pubsub=function(){this._pubsub||(this._pubsub=new KidoPubsub(this));return this._pubsub};var KidoQueues=function(d){var e=this;if(!(this instanceof KidoQueues))return new KidoQueues(d);if(!d)throw"The 'kidoApp' argument is required by the KidoQueues class.";this.app=d;this.rootUrl="/queue/local/";this.queue=function(b){return{push:function(c){c={url:e.rootUrl+b,type:"POST",data:JSON.stringify(c),dataType:"text"};return e.app.send(c)},dequeue:function(){return e.app.send({url:e.rootUrl+b+"/next",type:"DELETE"})}}}};
Kido.prototype.queues=function(){this._queues||(this._queues=new KidoQueues(this));return this._queues};var KidoSecurity=function(d){var e=this;if(!(this instanceof KidoSecurity))return new KidoSecurity(d);if(!d)throw"The 'kidoApp' argument is required by the KidoSecurity class.";this.app=d;this.getLoggedInUser=function(){return e.app.get("/user")};this.getOriginalToken=function(){return e.app.get("/user/original-token")}};Kido.prototype.security=function(){this._security||(this._security=new KidoSecurity(this));return this._security};var KidoSms=function(d){var e=this;if(!(this instanceof KidoSms))return new KidoSms(d);if(!d)throw"The 'kidoApp' argument is required by the KidoSms class.";this.app=d;this.send=function(b,c){if(!b)throw"The 'to' argument is required to send an sms.";if(!c)throw"The 'message' argument is required to send an sms.";return e.app.send({url:"/sms?to="+encodeURIComponent(b)+"&message="+encodeURIComponent(c),type:"POST"})};this.getStatus=function(b){if(!b)throw"The 'messageId' argument is required to get message status";
return e.app.get("/sms/"+b)}};Kido.prototype.sms=function(){this._sms||(this._sms=new KidoSms(this));return this._sms};var KidoStorage=function(d){var e=this;if(!(this instanceof KidoStorage))return new KidoStorage(d);this.app=d;this.rootUrl="/storage/local";this.getObjectSetNames=function(){return e.app.get(e.rootUrl)};this.objectSet=function(b,c){return new KidoObjectSet(b,this,c)}},KidoObjectSet=function(d,e,b){var c=this;if(!(this instanceof KidoObjectSet))return new KidoObjectSet(d,e);if(!e)throw"KidoObjectSet needs a parent KidoStorage object.";this.storage=e;this.name=d||"default";this.rootUrl=this.storage.rootUrl+
"/"+this.name;this.caching=b||!1;this.invoke=function(a){if(!a)throw"The storage 'data' argument is required";if(!a.settings)throw"The storage 'data.settings' property is required.";var b=[];a.query&&b.push("query="+JSON.stringify(a.query));a.options&&b.push("options="+JSON.stringify(a.options));a.fields&&b.push("fields="+JSON.stringify(a.fields));a.isPrivate&&b.push("isPrivate=true");a.settings.url=c.rootUrl+(a.objectId?"/"+a.objectId:"")+(a.indexes?"/"+a.indexes:"")+(b.length?"?"+b.join("&"):"");
a.settings.url=encodeURI(a.settings.url);a.settings.cache=a.cache;a.settings.kidoService={service:"storage",collection:c.name,objectId:a.objectId,query:a.query,caching:c.caching};return c.storage.app.send(a.settings)};this.insert=function(a,b){if(!a)throw"The object set 'obj' argument is requiered in order to insert.";a=$.extend({},a);a._id=void 0;var f={settings:{type:"POST",data:JSON.stringify(a)},isPrivate:b};return c.invoke(f).pipe(function(b){return $.extend(a,b)})};this.update=function(a,b){if(!a)throw"obj argument is requiered.";
a=$.extend({},a);var f={settings:{type:"PUT",data:JSON.stringify(a)},isPrivate:!!b};return c.invoke(f).pipe(function(b){return $.extend(a,b)},function(a){if(409===a.status)try{a.body=JSON.parse(a.responseText)}catch(b){}return a})};this.save=function(a,b){if(!a)throw"obj argument is requiered.";a=$.extend({},a);return a._id&&0<a._id.length?c.update(a,b):c.insert(a,b)};this.get=function(a){if(!a)throw"objectId is required";var b=$.Deferred();c.invoke({settings:{type:"GET"},objectId:a,cache:!1}).fail(function(a){404===
a.status?b.resolve(null):b.reject(a)}).done(function(a){b.resolve(a)});return b};this.query=function(a,b,d,e){return c.invoke({settings:{type:"GET"},query:a,fields:b,options:d,cache:e})};this.del=function(a){return c.invoke({settings:{type:"DELETE",dataType:"text"},objectId:a})};this.drop=function(){return c.invoke({settings:{type:"DELETE",dataType:"text"}})}};Kido.prototype.storage=function(){this._storage||(this._storage=new KidoStorage(this));return this._storage};var KidoStorageIndexes=function(d){var e=this;if(!(this instanceof KidoStorageIndexes))return new KidoStorageIndexes(d);if(!d)throw"The 'objectSet' argument is required by the KidoStorageIndexes class.";this.objectSet=d;this.all=function(){return e.objectSet.invoke({indexes:"indexes",settings:{type:"GET"}})};this.get=function(b){if(!b)throw"The 'name' argument is required to retrieve an object set index.";return e.objectSet.invoke({indexes:"indexes?name="+b,settings:{type:"GET"}})};this.del=function(b){if(!b)throw"The 'name' argument is required to delete an object set index.";
return e.objectSet.invoke({indexes:"indexes/"+b,settings:{type:"DELETE"}})};this.create=function(b,c,a,g,d,l,h,k){if(!b)throw"The 'spec' argument is required to create an index.";c||(c=!1);a||(a=!1);g||(g=!1);d||(d=!1);l||(l=!1);b={spec:b,options:{safe:c,unique:a,sparse:g,background:d,dropDups:l}};h&&"0"!=h.toString()&&(b.options.min=h);k&&"0"!=k.toString()&&(b.options.max=k);h={indexes:"indexes",settings:{type:"POST",data:JSON.stringify(b)}};return e.objectSet.invoke(h)}};
KidoObjectSet.prototype.indexes=function(){this._indexes||(this._indexes=new KidoStorageIndexes(this));return this._indexes};var KidoService=function(d,e){var b=this;if(!(this instanceof KidoService))return new KidoService(d);if(!d)throw"The 'kidoApp' argument is required by the KidoService class.";this.app=d;this.name=e;this._defaults={};this.defaults=function(c){b._defaults=$.extend(b._defaults,c||{});return b};this.invoke=function(c,a,d){var f=$.Deferred();a=$.extend({},b._defaults,a);b.app.post("/api/services/"+b.name+"/invoke/"+c,a,d?{headers:{timeout:d}}:{}).done(function(a){if(a.error)return f.reject(a.error);f.resolve(a.data||
a)}).fail(function(a){f.reject(a)});return f}};Kido.prototype.services=function(d){return new KidoService(this,d)};var KidoDatasource=function(d,e){var b=this;if(!(this instanceof KidoDatasource))return new KidoDatasource(d);if(!d)throw"The 'kidoApp' argument is required by the KidoDatasource class.";this.app=d;this.name=e;this._defaults={};this.defaults=function(c){b._defaults=$.extend(b._defaults,c||{});return b};this.query=function(c,a){!a&&$.isNumeric(c)&&(a=c,c=null);var d=$.Deferred(),f=$.extend({},b._defaults,c),f=0<Object.keys(f).length?"?"+$.param(f):"";b.app.get("/api/v2/datasources/"+b.name+f,a?{headers:{timeout:a}}:
{}).done(function(a){if(a.error)return d.reject(a.error);d.resolve(a.data||a)}).fail(function(a){d.reject(a)});return d};this.invoke=function(c,a){!a&&$.isNumeric(c)&&(a=c,c=null);var d=$.Deferred(),f=$.extend({},b._defaults,c);b.app.post("/api/v2/datasources/"+b.name,f,a?{headers:{timeout:a}}:{}).done(function(a){if(a.error)return d.reject(a.error);d.resolve(a.data||a)}).fail(function(a){d.reject(a)});return d}};Kido.prototype.datasources=function(d){return new KidoDatasource(this,d)};var KidoLocalStorage=function(d){if(!(this instanceof KidoLocalStorage))return new KidoLocalStorage(d);if(!localforage)throw"KidoLocalStorage needs Mozilla LocalForage to be able to work.";localforage.config({name:"kidozen",storeName:"kidozen"});localforage.setItemAsync=function(a,b){var c=$.Deferred();localforage.setItem(a,b).then(function(a){setTimeout(function(){c.resolve(a)},50)},function(){c.reject()});return c.promise()};localforage.getItemAsync=function(a){var b=$.Deferred();localforage.getItem(a).then(function(a){setTimeout(function(){b.resolve(a)},
50)},function(){b.reject()});return b.promise()};localforage.removeItemAsync=function(){var a=$.Deferred();localforage.removeItem(e.name).then(function(){setTimeout(function(){a.resolve()},50)});return a.promise()};var e=this,b=!1,c=new KidoLocalStorageCollection("id_dictionary",this),a=new KidoLocalStorageCollection("pending_requests",this);this.app=d;this.collection=function(a){return new KidoLocalStorageCollection(a,this)};this.addPendingRequest=function(b,c){return a.persist({_id:b,request:c})};
this.removePendingRequest=function(b){return a.del(b)};this.getNewIdFromDictionary=function(a){return c.get(a,!0).then(function(a){return a.new_id})};this.executePendingRequests=function(){if(b)return $.Deferred().reject();b=!0;return a.query().then(function(a){return e.makeAjaxCall(a)}).then(function(){b=!1;return $.Deferred().resolve()},function(a){b=!1;return $.Deferred().reject(a)})};this.makeAjaxCall=function(b){if(0===b.length)return $.Deferred().resolve();var c=b.shift();return $.ajax(c.request).then(function(d){return a.persist(b).then(function(){return e.updateKey(c,
d)}).then(function(){return e.makeAjaxCall(b)})})};this.updateKey=function(a,b){if("object"!==typeof b||a._id===b._id)return $.Deferred().resolve();var d=e.collection(a.request.kidoService.service+"."+a.request.kidoService.collection),h=a._id,k=b._id;return d.get(h,!0).then(function(a){a._id=k;return d.persist(a)}).then(function(){return d.del(h)}).then(function(){return c.persist({_id:h,new_id:k})},function(){return $.Deferred().resolve()})}},KidoLocalStorageCollection=function(d,e){var b=this;if(!(this instanceof
KidoLocalStorageCollection))return new KidoLocalStorageCollection(d,e);if(!d)throw"KidoLocalStorageCollection needs a name to be created.";if(!e)throw"KidoLocalStorageCollection needs a parent KidoLocalStorage object.";this.localStorage=e;this.name="kido."+d;this.storeCollection=function(c){return localforage.setItemAsync(b.name,c)};this.insertItem=function(c){c._id=(-1*$.now()).toString();return b.query().then(function(a){a.push(c);return b.storeCollection(a).then(function(){return c})})};this.updateItem=
function(c){return b.query().then(function(a){a||(a=[]);var d,e;for(e=0;d=a[e];e++)if(d._id===c._id){a[e]=c;break}if(0!==a.length&&a.length===e)return b.localStorage.getNewIdFromDictionary(c._id).then(function(a){c._id=a;return b.updateItem(c)},function(){a.push(c);return b.storeCollection(a).then(function(){return c})});0===a.length&&a.push(c);return b.storeCollection(a).then(function(){return c})})};this.persist=function(c){if(!c)throw"The 'new_val' argument is required in order to insert.";"object"!==
typeof c&&(c=JSON.parse(c));return $.isArray(c)?b.storeCollection(c):"undefined"!==typeof c._id?b.updateItem(c):b.insertItem(c)};this.get=function(c,a){if(!c)throw"The 'id' argument is required in order to get.";a||(a=!1);return b.query().then(function(d){for(var e,l=0;e=d[l];l++)if(e._id===c)return e;return a?$.Deferred().reject("Item not found"):b.localStorage.getNewIdFromDictionary(c).then(function(a){return b.get(a,!0)})})};this.query=function(c){return localforage.getItemAsync(b.name).then(function(a){a||
(a=[]);if("undefined"!==typeof c)for(var b in c)a=$.map(a,function(a){return a[b]===c[b]?a:null});return a})};this.del=function(c){if(!c)throw"The 'id' argument is required in order to delete.";return b.query().then(function(a){a=$.map(a,function(a){return a._id!==c?a:null});return b.persist(a)})};this.drop=function(){return localforage.removeItemAsync()};this.length=function(){return b.query().then(function(b){return b.length})}};
Kido.prototype.localStorage=function(){this._localStorage||(this._localStorage=new KidoLocalStorage(this));return this._localStorage};
