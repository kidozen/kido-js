// KidoZen Javascript SDK v0.1.5-refresh.
// Copyright (c) 2013 Kidozen, Inc. MIT Licensed
if(!JSON||!JSON.parse||!JSON.stringify)throw"KidoZen requires JSON.stringify. Try adding a polyfil lib like json2.js";
var Kido=function(c,d){function a(a){return $.ajax({dataType:"text",crossDomain:!0,url:a.endpoint,type:"POST",data:'<s:Envelope xmlns:s="http://www.w3.org/2003/05/soap-envelope" xmlns:a="http://www.w3.org/2005/08/addressing" xmlns:u="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"><s:Header><a:Action s:mustUnderstand="1">http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue</a:Action><a:To s:mustUnderstand="1">[To]</a:To><o:Security s:mustUnderstand="1" xmlns:o="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd"><o:UsernameToken u:Id="uuid-6a13a244-dac6-42c1-84c5-cbb345b0c4c4-1"><o:Username>[Username]</o:Username><o:Password Type="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-username-token-profile-1.0#PasswordText">[Password]</o:Password></o:UsernameToken></o:Security></s:Header><s:Body><trust:RequestSecurityToken xmlns:trust="http://docs.oasis-open.org/ws-sx/ws-trust/200512"><wsp:AppliesTo xmlns:wsp="http://schemas.xmlsoap.org/ws/2004/09/policy"><a:EndpointReference><a:Address>[ApplyTo]</a:Address></a:EndpointReference></wsp:AppliesTo><trust:KeyType>http://docs.oasis-open.org/ws-sx/ws-trust/200512/Bearer</trust:KeyType><trust:RequestType>http://docs.oasis-open.org/ws-sx/ws-trust/200512/Issue</trust:RequestType><trust:TokenType>urn:oasis:names:tc:SAML:2.0:assertion</trust:TokenType></trust:RequestSecurityToken></s:Body></s:Envelope>'.replace("[To]",a.endpoint).replace("[Username]",
a.user).replace("[Password]",a.pass).replace("[ApplyTo]",a.scope),headers:{"Content-Type":"application/soap+xml; charset=utf-8"}})}function b(a){return $.ajax({url:a.endpoint,data:{wrap_name:a.user,wrap_password:a.pass,wrap_scope:a.scope},type:"POST",dataType:"text"})}if(!(this instanceof Kido))return new Kido;var f=this,h=null,e=null,j=null;this.name=c||"local";this.marketplace=d;this.local="local"===this.name;this.authenticated=(this.active=!!d)?!1:!0;this.active&&(this.authConfig=$.ajax({url:this.marketplace+
"/publicapi/apps?name="+this.name}).pipe(function(a){if(!a||!a.length)return $.Deferred().reject("Application configuration not found.");f.url=a[0].url.substring(0,a[0].url.length-1);return a[0].authConfig}));this.authenticate=function(c,d,n){return!this.active?$.Deferred().reject("No need to authenticate to this Web App"):this.token=this.authConfig.pipe(function(m){var l=m.identityProviders;n=n||Object.keys(l)[0];l=l[n];if(!l)return $.Deferred().reject("Invalid Identity Provider");if(!l.protocol)return $.Deferred().reject("Invalid Identity Provider Protocol");
var p;if("wrapv0.9"===l.protocol.toLowerCase())p=b;else if("ws-trust"===l.protocol.toLowerCase())p=a;else return $.Deferred().reject("Protocol not supported yet.");return p({user:c,pass:d,scope:m.authServiceScope,endpoint:l.endpoint}).pipe(function(a){a=(/<Assertion(.*)<\/Assertion>/.exec(a)||[])[0];return!a?$.Deferred().reject("Unable to get a token from IDP"):$.ajax({url:m.authServiceEndpoint,type:"POST",data:{wrap_assertion:a,wrap_scope:m.applicationScope,wrap_assertion_format:"SAML"}}).pipe(function(a){if(!a||
!a.rawToken)return $.Deferred().reject("Unable to retrieve KidoZen token.");f.authenticated=!0;h=c;e=d;j=n;a.token='WRAP access_token="'+a.rawToken+'"';var b=decodeURIComponent(a.rawToken).split("&");a.claims=b;for(var l in b){var m=b[l];if(-1<m.indexOf("ExpiresOn")){a.expiresOn=~~m.split("=")[1]-2E4;break}}return a})})})};this.send=function(a){if(!a.url)return $.Deferred().reject({msg:"Not a valid ajax URL.",error:"Invalid URL"});var b=$.extend({},{type:"POST",cache:!0},a);b.data&&!b.contentType&&
(b.contentType="application/json");return f.active&&f.authenticated?f.token.pipe(function(a){return a.expiresOn<(new Date).getTime()?f.authenticate(h,e,j):a}).pipe(function(a){b.url=f.url+b.url;b.headers=b.headers||{};b.headers.authorization=a.token;return $.ajax(b)}):$.ajax(b)};this.get=function(a,b){b=$.extend({url:a,type:"GET"},b||{});return f.send(b)};this.post=function(a,b,c){c=$.extend({url:a,type:"POST",data:b?JSON.stringify(b):null},c||{});return f.send(c)};this.del=function(a,b){b=$.extend({url:a,
type:"DELETE"},b||{});return f.send(b)}};var KidoConfig=function(c){var d=this;if(!(this instanceof KidoConfig))return new KidoConfig(c);if(!c)throw"The 'kidoApp' argument is required by the KidoConfig class.";this.app=c;this.set=function(a,b){if(!a)throw"The config key 'name' is required to set a value.";return d.app.post("/config/"+a,b)};this.get=function(a){if(!a)throw"The config key 'name' is required to retrieve the value.";return d.app.get("/config/"+a)};this.getAll=function(){return d.app.get("/config")};this.del=function(a){if(!a)throw"The config key 'name' is required to delete a value.";
return d.app.del("/config/"+a)}};Kido.prototype.config=function(){this._config||(this._config=new KidoConfig(this));return this._config};var KidoEmail=function(c){var d=this;if(!(this instanceof KidoEmail))return new KidoEmail(c);if(!c)throw"The 'kidoApp' argument is required by the KidoEmail class.";this.app=c;this.send=function(a,b,f,c,e,j,k){if(a&&"object"===typeof a){var g=a;a=g.from;b=g.to;f=g.subject;c=g.bodyText;e=g.bodyHtml;j=g.attachments;k=g.timeout}if(!a)throw"The 'from' argument is required to send an email.";if(!b)throw"The 'to' argument is required to send an email.";!j&&e instanceof Array&&(j=e,e=null);g={to:b,from:a};
"string"===typeof f&&0<f.length&&(g.subject=f);"string"===typeof c&&0<c.length&&(g.bodyText=c);"string"===typeof e&&0<e.length&&(g.bodyHtml=e);j instanceof Array&&(g.attachments=j);return d.app.send({url:"/email",type:"POST",data:JSON.stringify(g),timeout:k||9E5})};this.attach=function(a,b,f){a instanceof HTMLFormElement&&(a=new FormData(a));if(a instanceof HTMLInputElement){if(!a.type||"file"!==a.type.toLowerCase())throw"HTML Input element must be of type 'file'.";a=a.files[0]}if(a instanceof File){var c=
a;a=new FormData;a.append(c.name,c)}if(a instanceof FormData)"function"===typeof b&&(f=b,b=null);else if("string"===typeof a){c=a;a=new FormData;if(!b||"function"===typeof b)throw"if a name was specified, 'data' argument is required.";"string"===typeof b&&(b=new Blob([b],{type:"text/text"}));if(!(b instanceof Blob))throw"'data' argument must be a string, a Blob instance or a File instance.";a.append(c,b,c)}else throw"The argument 'formOrName' is invalid.";var d=new jQuery.Deferred;b=function(a){d.reject(a.currentTarget)};
c=new XMLHttpRequest;c.upload&&"function"===typeof f&&c.upload.addEventListener("progress",f,!1);c.addEventListener("load",function(a){d.resolve(JSON.parse(a.currentTarget.response))},!1);c.addEventListener("error",b,!1);c.addEventListener("abort",b,!1);c.open("POST","/email/attachments");c.send(a);return d.promise()}};Kido.prototype.email=function(){this._email||(this._email=new KidoEmail(this));return this._email};var KidoLogging=function(c){var d=this;if(!(this instanceof KidoLogging))return new KidoLogging(c);if(!c)throw"The 'kidoApp' argument is required by the KidoLogging class.";this.app=c;this.writeVerbose=function(a){return this.write(a,0)};this.writeInfo=function(a){return this.write(a,1)};this.writeWarning=function(a){return this.write(a,2)};this.writeError=function(a){return this.write(a,3)};this.writeCritical=function(a){return this.write(a,4)};this.write=function(a,b){if(!a)throw"'data' argument is requiered.";
if(!b&&0!==b)throw"'level' argument is required.";if(!(0<=b&&4>=b))throw"'level' argument must be an integer number between 0 and 4.";return d.app.send({url:"/logging?level="+b,type:"POST",data:JSON.stringify(a)})};this.query=function(a,b){var c=[];a&&c.push("query="+JSON.stringify(a));b&&c.push("options="+JSON.stringify(b));return d.app.send({url:"/logging"+(0<c.length?"?"+c.join("&"):""),type:"GET"})};this.get=function(a,b,c,h){var e={};b&&(e.level=b);if(a){if(!(a instanceof Date))throw"'Since' argument accepts only null or Date values.";
e.dateTime={$gt:a}}else e.dateTime={$exists:!0};a={$sort:{dateTime:-1}};c&&(a.$skip=c);h&&(a.$limit=h);return d.query(e,a)};this.clear=function(){return d.app.send({url:"/logging",type:"DELETE",dataType:"text"})}};Kido.prototype.logging=function(){this._logging||(this._logging=new KidoLogging(this));return this._logging};var KidoNotifications=function(c){var d=this;if(!(this instanceof KidoNotifications))return new KidoNotifications(c);if(!c)throw"The 'kidoApp' argument is required by the KidoNotifications class.";this.app=c;this.send=function(a,b,c,h,e,j,k){if(!a)throw"'channel' argument is required.";if(!b)throw"'title' argument is required.";b={title:b};"string"===typeof h&&h&&(b.type=h);"string"===typeof c&&c&&(b.text=c);"string"===typeof j&&j&&(b.image=j);"number"===typeof e&&(b.badge=e);k&&(b.param=k);return d.app.send({url:"/notifications/push/local/"+
a,type:"POST",data:JSON.stringify(b)})};this.subscribe=function(a,b,c,h){if(!a)throw"'deviceId' argument is required.";if(!b)throw"'channel' argument is required.";if(!c)throw"'subscriptionId' argument is required.";if(!h)throw"'platform' is required. Use one of: gcm, apns, c2dm, mpns or wns.";return d.app.send({url:"/notifications/subscriptions/local/"+b,type:"POST",data:JSON.stringify({deviceId:a,subscriptionId:c,platform:h})})}};
Kido.prototype.notifications=function(){this._notifications||(this._notifications=new KidoNotifications(this));return this._notifications};var KidoPubsub=function(c){var d=this;if(!(this instanceof KidoPubsub))return new KidoPubsub(c);if(!c)throw"The 'kidoApp' argument is required by the KidoPubsub class.";this.app=c;this.channel=function(a){return new KidoPubsubChannel(a,d.app)}},KidoPubsubChannel=function(c,d){var a=this;this.name=c;this.app=d;this.rootUrl="/pubsub/local/";this.publish=function(b){return a.app.send({url:a.rootUrl+a.name,type:"POST",data:JSON.stringify(b),dataType:"text"})};this.subscribe=function(b){var c=io.connect("/pubsub");
c.on("connect",function(){c.emit("bindToChannel",{application:a.app.name,channel:a.name})});c.on("bindAccepted",function(a){c.on(a.responseChannelName,b)});return function(){c.disconnect()}}};Kido.prototype.pubsub=function(){this._pubsub||(this._pubsub=new KidoPubsub(this));return this._pubsub};var KidoQueues=function(c){var d=this;if(!(this instanceof KidoQueues))return new KidoQueues(c);if(!c)throw"The 'kidoApp' argument is required by the KidoQueues class.";this.app=c;this.rootUrl="/queue/local/";this.queue=function(a){return{push:function(b){b={url:d.rootUrl+a,type:"POST",data:JSON.stringify(b),dataType:"text"};return d.app.send(b)},dequeue:function(){return d.app.send({url:d.rootUrl+a+"/next",type:"DELETE"})}}}};
Kido.prototype.queues=function(){this._queues||(this._queues=new KidoQueues(this));return this._queues};var KidoSecurity=function(c){var d=this;if(!(this instanceof KidoSecurity))return new KidoSecurity(c);if(!c)throw"The 'kidoApp' argument is required by the KidoSecurity class.";this.app=c;this.getLoggedInUser=function(){return d.app.get("/user")};this.getOriginalToken=function(){return d.app.get("/user/original-token")}};Kido.prototype.security=function(){this._security||(this._security=new KidoSecurity(this));return this._security};var KidoSms=function(c){var d=this;if(!(this instanceof KidoSms))return new KidoSms(c);if(!c)throw"The 'kidoApp' argument is required by the KidoSms class.";this.app=c;this.send=function(a,b){return d.app.post({url:"/sms?to="+encodeURIComponent(a)+"&message="+encodeURIComponent(b),headers:{"Content-Length":0}})};this.getStatus=function(a){return d.app.get("/sms/"+a)}};Kido.prototype.sms=function(){this._sms||(this._sms=new KidoSms(this));return this._sms};var KidoStorage=function(c){var d=this;if(!(this instanceof KidoStorage))return new KidoStorage(c);this.app=c;this.rootUrl="/storage/local";this.getObjectSetNames=function(){return d.app.get(d.rootUrl)};this.objectSet=function(a){return new KidoObjectSet(a,this)}},KidoObjectSet=function(c,d){var a=this;if(!(this instanceof KidoObjectSet))return new KidoObjectSet(c,d);if(!d)throw"KidoObjectSet needs a parent KidoStorage object.";this.storage=d;this.name=c||"default";this.rootUrl=this.storage.rootUrl+
"/"+this.name;this.invoke=function(b){if(!b)throw"The storage 'data' argument is required";if(!b.settings)throw"The storage 'data.settings' property is required.";var c=[];b.query&&c.push("query="+JSON.stringify(b.query));b.options&&c.push("options="+JSON.stringify(b.options));b.fields&&c.push("fields="+JSON.stringify(b.fields));b.isPrivate&&c.push("isPrivate=true");b.settings.url=a.rootUrl+(b.objectId?"/"+b.objectId:"")+(b.indexes?"/"+b.indexes:"")+(c.length?"?"+c.join("&"):"");b.settings.url=encodeURI(b.settings.url);
b.settings.cache=b.cache;return a.storage.app.send(b.settings)};this.insert=function(b,c){if(!b)throw"The object set 'obj' argument is requiered in order to insert.";b=$.extend({},b);b._id=void 0;var d={settings:{type:"POST",data:JSON.stringify(b)},isPrivate:c};return a.invoke(d).pipe(function(a){return $.extend(b,a)})};this.update=function(b,c){if(!b)throw"obj argument is requiered.";b=$.extend({},b);var d={settings:{type:"PUT",data:JSON.stringify(b)},isPrivate:!!c};return a.invoke(d).pipe(function(a){return $.extend(b,
a)},function(a){if(409===a.status)try{a.body=JSON.parse(a.responseText)}catch(b){}return a})};this.save=function(b,c){if(!b)throw"obj argument is requiered.";b=$.extend({},b);return b._id&&0<b._id.length?a.update(b,c):a.insert(b,c)};this.get=function(b){if(!b)throw"objectId is required";var c=$.Deferred();a.invoke({settings:{type:"GET"},objectId:b,cache:!1}).fail(function(a){404===a.status?c.resolve(null):c.reject(a)}).done(function(a){c.resolve(a)});return c};this.query=function(b,c,d,e){return a.invoke({settings:{type:"GET"},
query:b,fields:c,options:d,cache:e})};this.del=function(b){return a.invoke({settings:{type:"DELETE",dataType:"text"},objectId:b})};this.drop=function(){return a.invoke({settings:{type:"DELETE",dataType:"text"}})}};Kido.prototype.storage=function(){this._storage||(this._storage=new KidoStorage(this));return this._storage};var KidoStorageIndexes=function(c){var d=this;if(!(this instanceof KidoStorageIndexes))return new KidoStorageIndexes(c);if(!c)throw"The 'objectSet' argument is required by the KidoStorageIndexes class.";this.objectSet=c;this.all=function(){return d.objectSet.invoke({indexes:"indexes",settings:{type:"GET"}})};this.get=function(a){if(!a)throw"The 'name' argument is required to retrieve an object set index.";return d.objectSet.invoke({indexes:"indexes?name="+a,settings:{type:"GET"}})};this.del=function(a){if(!a)throw"The 'name' argument is required to delete an object set index.";
return d.objectSet.invoke({indexes:"indexes/"+a,settings:{type:"DELETE"}})};this.create=function(a,b,c,h,e,j,k,g){if(!a)throw"The 'spec' argument is required to create an index.";b||(b=!1);c||(c=!1);h||(h=!1);e||(e=!1);j||(j=!1);a={spec:a,options:{safe:b,unique:c,sparse:h,background:e,dropDups:j}};k&&"0"!=k.toString()&&(a.options.min=k);g&&"0"!=g.toString()&&(a.options.max=g);k={indexes:"indexes",settings:{type:"POST",data:JSON.stringify(a)}};return d.objectSet.invoke(k)}};
KidoObjectSet.prototype.indexes=function(){this._indexes||(this._indexes=new KidoStorageIndexes(this));return this._indexes};var KidoService=function(c,d){var a=this;if(!(this instanceof KidoService))return new KidoService(c);if(!c)throw"The 'kidoApp' argument is required by the KidoService class.";this.app=c;this.name=d;this._defaults={};this.defaults=function(b){a._defaults=$.extend(a._defaults,b||{});return a};this.invoke=function(b,c,d){var e=$.Deferred();c=$.extend({},a._defaults,c);a.app.post("/api/services/"+a.name+"/invoke/"+b,c,d?{headers:{timeout:d}}:{}).done(function(a){if(a.error)return e.reject(a.error);e.resolve(a.data||
a)}).fail(function(a){e.reject(a)});return e}};Kido.prototype.services=function(c){return new KidoService(this,c)};
