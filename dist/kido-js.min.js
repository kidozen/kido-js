// KidoZen Javascript SDK v0.1.10.
// Copyright (c) 2013 Kidozen, Inc. MIT Licensed
if(!JSON||!JSON.parse||!JSON.stringify)throw"KidoZen requires JSON.stringify. Try adding a polyfil lib like json2.js";
var Kido=function(d,c,a){function b(a){return"undefined"===typeof a.kidoService||!a.kidoService.caching&&!a.kidoService.queueing?$.ajax(a):h.offline().ajax(a)}function e(a){return $.ajax({dataType:"text",crossDomain:!0,url:a.endpoint,type:"POST",data:'<s:Envelope xmlns:s="http://www.w3.org/2003/05/soap-envelope" xmlns:a="http://www.w3.org/2005/08/addressing" xmlns:u="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"><s:Header><a:Action s:mustUnderstand="1">http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue</a:Action><a:To s:mustUnderstand="1">[To]</a:To><o:Security s:mustUnderstand="1" xmlns:o="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd"><o:UsernameToken u:Id="uuid-6a13a244-dac6-42c1-84c5-cbb345b0c4c4-1"><o:Username>[Username]</o:Username><o:Password Type="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-username-token-profile-1.0#PasswordText">[Password]</o:Password></o:UsernameToken></o:Security></s:Header><s:Body><trust:RequestSecurityToken xmlns:trust="http://docs.oasis-open.org/ws-sx/ws-trust/200512"><wsp:AppliesTo xmlns:wsp="http://schemas.xmlsoap.org/ws/2004/09/policy"><a:EndpointReference><a:Address>[ApplyTo]</a:Address></a:EndpointReference></wsp:AppliesTo><trust:KeyType>http://docs.oasis-open.org/ws-sx/ws-trust/200512/Bearer</trust:KeyType><trust:RequestType>http://docs.oasis-open.org/ws-sx/ws-trust/200512/Issue</trust:RequestType><trust:TokenType>urn:oasis:names:tc:SAML:2.0:assertion</trust:TokenType></trust:RequestSecurityToken></s:Body></s:Envelope>'.replace("[To]",a.endpoint).replace("[Username]",
a.user).replace("[Password]",a.pass).replace("[ApplyTo]",a.scope),headers:{"Content-Type":"application/soap+xml; charset=utf-8"}})}function l(a){return $.ajax({url:a.endpoint,data:{wrap_name:a.user,wrap_password:a.pass,wrap_scope:a.scope},type:"POST",dataType:"text"})}function f(a){if(!a.signInUrl)return $.Deferred().reject("Passive Authentication not supported.");if("undefined"===typeof window.atob)return $.Deferred().reject("Browser does not support window.atob()");var b=$.Deferred(),e=window.open(a.signInUrl,
"_blank","location=yes");h.isNative?(e.addEventListener("loadstop",function(){e.executeScript({code:"document.title;"},function(a){a=a[0];if(-1!==a.indexOf("Success payload=")){try{var c=m(a);h.authenticated=!0;b.resolve(c)}catch(l){b.reject("Unable to retrieve KidoZen token.")}e.close()}})}),e.addEventListener("loaderror",function(){b.reject("InAppBrowser error loading page.");e.close()}),e.addEventListener("exit",function(){b.reject("InAppBrowser has exited.")})):window.addEventListener("message",
function(c){var l=document.createElement("a");l.href=a.signInUrl;if(c.origin!==l.protocol+"//"+l.host)return b.reject("Unable to retrieve KidoZen token.");try{var d=m(c.data);h.authenticated=!0;b.resolve(d)}catch(f){b.reject("Unable to retrieve KidoZen token.")}e.close()},!1);return b.promise()}function g(a,b,c,d,f){var g;if("wrapv0.9"===f.protocol.toLowerCase())g=l;else if("ws-trust"===f.protocol.toLowerCase())g=e;else return $.Deferred().reject("Protocol not supported yet.");return g({user:b,pass:c,
scope:a.authServiceScope,endpoint:f.endpoint}).then(function(e){return(e=(/<Assertion(.*)<\/Assertion>/.exec(e)||[])[0])?$.ajax({url:a.authServiceEndpoint,type:"POST",data:{wrap_assertion:e,wrap_scope:a.applicationScope,wrap_assertion_format:"SAML"}}).then(function(a){if(!a||!a.access_token&&!a.rawToken)return $.Deferred().reject("Unable to retrieve KidoZen token.");h.authenticated=!0;x=b;y=c;z=d;return k(a)}):$.Deferred().reject("Unable to get a token from IDP")})}function m(a){if(-1===a.indexOf("Success payload="))throw"Unable to retrieve KidoZen token.";
a=JSON.parse(window.atob(a.replace("Success payload=","")));if(!a||!a.access_token&&!a.rawToken)throw"Unable to retrieve KidoZen token.";return k(a)}function k(a){var b=a.access_token?a.access_token:a.rawToken;a.token='WRAP access_token="'+b+'"';b=decodeURIComponent(b).split("&");a.claims=b;for(var e in b)if(b[e]){var c=b[e];if(-1<c.indexOf("ExpiresOn")){a.expiresOn=1E3*~~c.split("=")[1]-2E4;break}}return a}if(!(this instanceof Kido))return new Kido;if("undefined"===typeof $)throw"jQuery 1.8 or above is required to use the Kido SDK.";
if("undefined"===typeof $.fn||"undefined"===typeof $.fn.jquery)throw"Could not determine jQuery version.";var D=$.fn.jquery.split(".");if(2>parseInt(D[0])&&8>parseInt(D[1]))throw"jQuery 1.8 or above is required to use the Kido SDK.";if("undefined"!==typeof c)if(-1===c.indexOf("://"))c="https://"+c;else if(0!==c.indexOf("http://")&&0!==c.indexOf("https://"))throw"Marketplace url must begin with https://";var h=this,x=null,y=null,z=null,C=null;this.name=d||"local";this.marketplace=c;this.local="local"===
this.name;this.authenticated=(this.hosted=!c)?!0:!1;this.isNative=-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://");"object"===typeof a&&("object"===typeof a.token&&(this.inheritedToken=a.token),"string"===typeof a.username&&(x=a.username),"string"===typeof a.password&&(y=a.password),"string"===typeof a.provider&&(z=a.provider),"string"===typeof a.secretKey&&(C=a.secretKey));this.hosted||(this.getConfig=$.ajax({url:this.marketplace+"/publicapi/apps?name="+this.name}).then(function(a){if(!a||
!a.length)return $.Deferred().reject("Application configuration not found.");h.url=a[0].url.substring(0,a[0].url.length-1);return a[0]},function(){return $.Deferred().reject("Unable to retrieve application configuration. Either there is no internet connection or the marketplace url is invalid.")}));this.authenticate=function(){if(h.hosted)return $.Deferred().resolve("No need to authenticate to this Web App");var a=arguments;h.token=h.getConfig.then(function(b){if(0===a.length&&h.inheritedToken)return h.authenticated=
!0,k(h.inheritedToken);if(0===a.length)return f(b.authConfig);var e=b.authConfig.identityProviders,c=a[2]||Object.keys(e)[0];return(e=e[c])?e.protocol?g(b.authConfig,a[0],a[1],a[2],e):$.Deferred().reject("Invalid Identity Provider Protocol"):$.Deferred().reject("Invalid Identity Provider")});return h.token};this.send=function(a){if(!a.url)return $.Deferred().reject({msg:"Not a valid ajax URL.",error:"Invalid URL"});var e=$.extend({},{type:"POST",cache:!0},a);e.data&&!e.contentType&&(e.contentType=
"application/json");return!h.hosted&&h.authenticated?h.token.then(function(a){if(a.expiresOn<(new Date).getTime()){if(x&&y&&z)return h.authenticate(x,y,z);if(!C)return h.authenticate();var b=a.refresh_token;h.token=h.getConfig.then(function(a){return $.ajax({url:a.authConfig.oauthTokenEndpoint,type:"POST",data:{grant_type:"refresh_token",client_id:a.domain,client_secret:C,scope:a.authConfig.applicationScope,refresh_token:b}}).then(function(a){if(!a||!a.access_token&&!a.rawToken)return h.authenticated=
!1,$.Deferred().reject("Unable to retrieve KidoZen token.");a.refresh_token=b;return k(a)})});return h.token}return a}).then(function(a){e.url=h.url+e.url;e.headers=e.headers||{};e.headers.authorization=a.token;return b(e)}):b(e)};this.get=function(a,b){b=$.extend({url:a,type:"GET"},b||{});return h.send(b)};this.post=function(a,b,e){e=$.extend({url:a,type:"POST",data:b?JSON.stringify(b):null},e||{});return h.send(e)};this.del=function(a,b){b=$.extend({url:a,type:"DELETE"},b||{});return h.send(b)}};var KidoConfig=function(d){if(!(this instanceof KidoConfig))return new KidoConfig(d);if(!d)throw"The 'kidoApp' argument is required by the KidoConfig class.";var c=this;this.app=d;this.SERVICE_NAME="config";this.set=function(a,b){if(!a)throw"The config key 'name' is required to set a value.";return c.app.post("/config/"+a,b)};this.get=function(a){if(!a)throw"The config key 'name' is required to retrieve the value.";return c.app.get("/config/"+a)};this.getAll=function(){return c.app.get("/config")};
this.del=function(a){if(!a)throw"The config key 'name' is required to delete a value.";return c.app.del("/config/"+a)}};Kido.prototype.config=function(){this._config||(this._config=new KidoConfig(this));return this._config};var KidoEmail=function(d){if(!(this instanceof KidoEmail))return new KidoEmail(d);if(!d)throw"The 'kidoApp' argument is required by the KidoEmail class.";var c=this;this.app=d;this.SERVICE_NAME="email";this.send=function(a,b,e,l,d,g,m){if(a&&"object"===typeof a){var k=a;a=k.from;b=k.to;e=k.subject;l=k.bodyText;d=k.bodyHtml;g=k.attachments;m=k.timeout}if(!a)throw"The 'from' argument is required to send an email.";if(!b)throw"The 'to' argument is required to send an email.";!g&&d instanceof Array&&
(g=d,d=null);k={to:b,from:a};"string"===typeof e&&0<e.length&&(k.subject=e);"string"===typeof l&&0<l.length&&(k.bodyText=l);"string"===typeof d&&0<d.length&&(k.bodyHtml=d);g instanceof Array&&(k.attachments=g);return c.app.send({url:"/email",type:"POST",data:JSON.stringify(k),timeout:m||9E5})};this.attach=function(a,b,e){a instanceof HTMLFormElement&&(a=new FormData(a));if(a instanceof HTMLInputElement){if(!a.type||"file"!==a.type.toLowerCase())throw"HTML Input element must be of type 'file'.";a=
a.files[0]}if(a instanceof File){var c=a;a=new FormData;a.append(c.name,c)}if(a instanceof FormData)"function"===typeof b&&(e=b,b=null);else if("string"===typeof a){c=a;a=new FormData;if(!b||"function"===typeof b)throw"if a name was specified, 'data' argument is required.";"string"===typeof b&&(b=new Blob([b],{type:"text/text"}));if(!(b instanceof Blob))throw"'data' argument must be a string, a Blob instance or a File instance.";a.append(c,b,c)}else throw"The argument 'formOrName' is invalid.";var d=
new jQuery.Deferred;b=function(a){d.reject(a.currentTarget)};c=new XMLHttpRequest;c.upload&&"function"===typeof e&&c.upload.addEventListener("progress",e,!1);c.addEventListener("load",function(a){d.resolve(JSON.parse(a.currentTarget.response))},!1);c.addEventListener("error",b,!1);c.addEventListener("abort",b,!1);c.open("POST","/email/attachments");c.send(a);return d.promise()}};Kido.prototype.email=function(){this._email||(this._email=new KidoEmail(this));return this._email};var KidoLogging=function(d){if(!(this instanceof KidoLogging))return new KidoLogging(d);if(!d)throw"The 'kidoApp' argument is required by the KidoLogging class.";var c=this;this.app=d;this.SERVICE_NAME="logging";this.writeVerbose=function(a){return c.write(a,0)};this.writeInfo=function(a){return c.write(a,1)};this.writeWarning=function(a){return c.write(a,2)};this.writeError=function(a){return c.write(a,3)};this.writeCritical=function(a){return c.write(a,4)};this.write=function(a,b,e){if(!a)throw"'data' argument is requiered.";
if(!b&&0!==b)throw"'level' argument is required.";if(!(0<=b&&4>=b))throw"'level' argument must be an integer number between 0 and 4.";return c.app.send({url:"/api/v3/logging/log?level="+b+(e?"&message="+encodeURIComponent(e):""),type:"POST",data:JSON.stringify(a)})};this.query=function(a){var b=[];a&&b.push("query="+JSON.stringify(a));return c.app.send({url:"/api/v3/logging/log"+(0<b.length?"?"+b.join("&"):""),type:"GET"})};this.get=function(a,b,e,d){var f={query:{},sort:[{"@timestamp":{order:"desc"}}],
filter:{}};b?f.query.match={level:{query:b,operator:"and"}}:f.query.match_all={};if(a){if(!(a instanceof Date))throw"'Since' argument accepts only null or Date values.";f.filter={range:{"@timestamp":{gte:a}}}}e&&(f.from=e);d&&(f.size=d);return c.query(f)};this.clear=function(){return c.app.send({url:"/api/v3/logging/log",type:"DELETE",dataType:"text"})}};Kido.prototype.logging=function(){this._logging||(this._logging=new KidoLogging(this));return this._logging};var KidoNotifications=function(d){if(!(this instanceof KidoNotifications))return new KidoNotifications(d);if(!d)throw"The 'kidoApp' argument is required by the KidoNotifications class.";var c=this;this.app=d;this.SERVICE_NAME="notifications";this.send=function(a,b,e,d,f,g,m){if(!a)throw"'channel' argument is required.";if(!b)throw"'title' argument is required.";b={title:b};"string"===typeof d&&d&&(b.type=d);"string"===typeof e&&e&&(b.text=e);"string"===typeof g&&g&&(b.image=g);"number"===typeof f&&
(b.badge=f);m&&(b.param=m);return c.app.send({url:"/notifications/push/local/"+a,type:"POST",data:JSON.stringify(b)})};this.subscribe=function(a,b,e,d){if(!a)throw"'deviceId' argument is required.";if(!b)throw"'channel' argument is required.";if(!e)throw"'subscriptionId' argument is required.";if(!d)throw"'platform' is required. Use one of: gcm, apns, c2dm, mpns or wns.";return c.app.send({url:"/notifications/subscriptions/local/"+b,type:"POST",data:JSON.stringify({deviceId:a,subscriptionId:e,platform:d})})}};
Kido.prototype.notifications=function(){this._notifications||(this._notifications=new KidoNotifications(this));return this._notifications};var KidoPubsub=function(d){if(!(this instanceof KidoPubsub))return new KidoPubsub(d);if(!d)throw"The 'kidoApp' argument is required by the KidoPubsub class.";var c=this;this.app=d;this.SERVICE_NAME="pubsub";this.channel=function(a){return new KidoPubsubChannel(a,c.app)}},KidoPubsubChannel=function(d,c){var a=this;this.name=d;this.app=c;this.rootUrl="/pubsub/local/";this.publish=function(b){return a.app.send({url:a.rootUrl+a.name,type:"POST",data:JSON.stringify(b),dataType:"text"})};this.subscribe=
function(b){var e=io.connect("/pubsub");e.on("connect",function(){e.emit("bindToChannel",{application:a.app.name,channel:a.name})});e.on("bindAccepted",function(a){e.on(a.responseChannelName,b)});return function(){e.disconnect()}}};Kido.prototype.pubsub=function(){this._pubsub||(this._pubsub=new KidoPubsub(this));return this._pubsub};var KidoQueues=function(d){if(!(this instanceof KidoQueues))return new KidoQueues(d);if(!d)throw"The 'kidoApp' argument is required by the KidoQueues class.";var c=this;this.app=d;this.rootUrl="/queue/local/";this.SERVICE_NAME="queue";this.queue=function(a){return{push:function(b){b={url:c.rootUrl+a,type:"POST",data:JSON.stringify(b),dataType:"text"};return c.app.send(b)},dequeue:function(){return c.app.send({url:c.rootUrl+a+"/next",type:"DELETE"})}}}};
Kido.prototype.queues=function(){this._queues||(this._queues=new KidoQueues(this));return this._queues};var KidoSecurity=function(d){if(!(this instanceof KidoSecurity))return new KidoSecurity(d);if(!d)throw"The 'kidoApp' argument is required by the KidoSecurity class.";var c=this;this.app=d;this.SERVICE_NAME="security";this.getLoggedInUser=function(){return c.app.get("/user").then(function(a){var b={};a.forEach(function(a){var c=a.type.substring(a.type.lastIndexOf("/")+1);b[c]=a.value});return b})};this.getOriginalToken=function(){return c.app.get("/user/original-token")};this.getJWT=function(a){return c.app.get("/api/v3/delegation/token"+
(a?"?gzip=true":""))}};Kido.prototype.security=function(){this._security||(this._security=new KidoSecurity(this));return this._security};var KidoSms=function(d,c){if(!(this instanceof KidoSms))return new KidoSms(d);if(!d)throw"The 'kidoApp' argument is required by the KidoSms class.";c||(c={queueing:!1});var a=this;this.app=d;this.SERVICE_NAME="sms";this.caching=!1;this.queueing=c.queueing||!1;this.send=function(b,e){if(!b)throw"The 'to' argument is required to send an sms.";if(!e)throw"The 'message' argument is required to send an sms.";var c={url:"/sms?to="+encodeURIComponent(b)+"&message="+encodeURIComponent(e),type:"POST"};c.kidoService=
{service:a.SERVICE_NAME,caching:a.caching,queueing:a.queueing};return a.app.send(c)};this.getStatus=function(b){if(!b)throw"The 'messageId' argument is required to get message status";return a.app.get("/sms/"+b)}};Kido.prototype.sms=function(d){this._sms||(this._sms=new KidoSms(this,d));return this._sms};var KidoStorage=function(d){if(!(this instanceof KidoStorage))return new KidoStorage(d);var c=this;this.app=d;this.SERVICE_NAME="storage";this.rootUrl="/storage/local";this.getObjectSetNames=function(){return c.app.get(c.rootUrl)};this.objectSet=function(a,b){return new KidoObjectSet(a,this,b)}},KidoObjectSet=function(d,c,a){if(!(this instanceof KidoObjectSet))return new KidoObjectSet(d,c);if(!c)throw"KidoObjectSet needs a parent KidoStorage object.";a||(a={caching:!1,queueing:!1});var b=this;this.storage=
c;this.name=d||"default";this.rootUrl=this.storage.rootUrl+"/"+this.name;this.caching=a.caching||!1;this.queueing=a.queueing||!1;this.invoke=function(a){if(!a)throw"The storage 'data' argument is required";if(!a.settings)throw"The storage 'data.settings' property is required.";var c=[];a.query&&c.push("query="+JSON.stringify(a.query));a.options&&c.push("options="+JSON.stringify(a.options));a.fields&&c.push("fields="+JSON.stringify(a.fields));a.isPrivate&&c.push("isPrivate=true");a.settings.url=b.rootUrl+
(a.objectId?"/"+a.objectId:"")+(a.indexes?"/"+a.indexes:"")+(c.length?"?"+c.join("&"):"");a.settings.url=encodeURI(a.settings.url);a.settings.cache=a.cache;a.settings.kidoService={service:b.storage.SERVICE_NAME,collection:b.name,objectId:a.objectId,query:a.query,caching:b.caching,queueing:b.queueing};return b.storage.app.send(a.settings)};this.insert=function(a,c){if(!a)throw"The object set 'obj' argument is requiered in order to insert.";a=$.extend({},a);a._id=void 0;var d={settings:{type:"POST",
data:JSON.stringify(a)},isPrivate:c};return b.invoke(d).then(function(b){return $.extend(a,b)})};this.update=function(a,c){if(!a)throw"obj argument is requiered.";a=$.extend({},a);var d={settings:{type:"PUT",data:JSON.stringify(a)},isPrivate:!!c};return b.invoke(d).then(function(b){return $.extend(a,b)},function(a){if(409===a.status)try{a.body=JSON.parse(a.responseText)}catch(b){}return a})};this.save=function(a,c){if(!a)throw"obj argument is requiered.";a=$.extend({},a);return a._id&&0<a._id.length?
b.update(a,c):b.insert(a,c)};this.get=function(a){if(!a)throw"objectId is required";var c=$.Deferred();b.invoke({settings:{type:"GET"},objectId:a,cache:!1}).fail(function(a){404===a.status?c.resolve(null):c.reject(a)}).done(function(a){c.resolve(a)});return c};this.query=function(a,c,d,g){return b.invoke({settings:{type:"GET"},query:a,fields:c,options:d,cache:g})};this.del=function(a){return b.invoke({settings:{type:"DELETE",dataType:"text"},objectId:a})};this.drop=function(){return b.invoke({settings:{type:"DELETE",
dataType:"text"}})}};Kido.prototype.storage=function(){this._storage||(this._storage=new KidoStorage(this));return this._storage};var KidoStorageIndexes=function(d){if(!(this instanceof KidoStorageIndexes))return new KidoStorageIndexes(d);if(!d)throw"The 'objectSet' argument is required by the KidoStorageIndexes class.";var c=this;this.objectSet=d;this.SERVICE_NAME="storageindexes";this.all=function(){return c.objectSet.invoke({indexes:"indexes",settings:{type:"GET"}})};this.get=function(a){if(!a)throw"The 'name' argument is required to retrieve an object set index.";return c.objectSet.invoke({indexes:"indexes?name="+a,settings:{type:"GET"}})};
this.del=function(a){if(!a)throw"The 'name' argument is required to delete an object set index.";return c.objectSet.invoke({indexes:"indexes/"+a,settings:{type:"DELETE"}})};this.create=function(a,b,e,d,f,g,m,k){if(!a)throw"The 'spec' argument is required to create an index.";b||(b=!1);e||(e=!1);d||(d=!1);f||(f=!1);g||(g=!1);a={spec:a,options:{safe:b,unique:e,sparse:d,background:f,dropDups:g}};m&&"0"!=m.toString()&&(a.options.min=m);k&&"0"!=k.toString()&&(a.options.max=k);m={indexes:"indexes",settings:{type:"POST",
data:JSON.stringify(a)}};return c.objectSet.invoke(m)}};KidoObjectSet.prototype.indexes=function(){this._indexes||(this._indexes=new KidoStorageIndexes(this));return this._indexes};var KidoService=function(d,c){if(!(this instanceof KidoService))return new KidoService(d);if(!d)throw"The 'kidoApp' argument is required by the KidoService class.";var a=this;this.app=d;this.name=c;this._defaults={};this.SERVICE_NAME="services";this.defaults=function(b){a._defaults=$.extend(a._defaults,b||{});return a};this.invoke=function(b,c,d){var f=$.Deferred();c=$.extend({},a._defaults,c);a.app.post("/api/services/"+a.name+"/invoke/"+b,c,d?{headers:{timeout:d}}:{}).done(function(a){if(a.error)return f.reject(a.error);
f.resolve(a.data||a)}).fail(function(a){f.reject(a)});return f}};Kido.prototype.services=function(d){return new KidoService(this,d)};var KidoDatasource=function(d,c,a){if(!(this instanceof KidoDatasource))return new KidoDatasource(d,c);if(!d)throw"The 'kidoApp' argument is required by the KidoDatasource class.";if(!c)throw"The 'name' argument is required by the KidoDatasource class.";a||(a={caching:!1,queueing:!1,timeout:null});var b=this;this.app=d;this.SERVICE_NAME="datasources";this.name=c;this._defaults={};this.caching=a.caching||!1;this.queueing=a.queueing||!1;this.timeout=a.timeout||null;this.defaults=function(a){b._defaults=
$.extend(b._defaults,a||{});return b};this.query=function(a){var c=$.Deferred();a=$.extend({},b._defaults,a);a=0<Object.keys(a).length?"?"+$.param(a):"";var d=b.timeout?{headers:{timeout:b.timeout}}:{};d.kidoService={service:b.SERVICE_NAME,collection:b.name,caching:b.caching,queueing:!1};b.app.get("/api/v2/datasources/"+b.name+a,d).done(function(a){if(a.error)return c.reject(a.error);c.resolve(a.data||a)}).fail(function(a){c.reject(a)});return c};this.invoke=function(a){var c=$.Deferred();a=$.extend({},
b._defaults,a);var d=b.timeout?{headers:{timeout:b.timeout}}:{};d.kidoService={service:b.SERVICE_NAME,collection:b.name,caching:!1,queueing:b.queueing};b.app.post("/api/v2/datasources/"+b.name,a,d).done(function(a){if(a.error)return c.reject(a.error);c.resolve(a.data||a)}).fail(function(a){c.reject(a)});return c}};Kido.prototype.datasources=function(d,c){return new KidoDatasource(this,d,c)};var KidoLocalStorage=function(d){if(!(this instanceof KidoLocalStorage))return new KidoLocalStorage(d);if(!localforage)throw"KidoLocalStorage needs Mozilla LocalForage to be able to work.";this.app=d;this.SERVICE_NAME="localstorage";localforage.config({name:"kidozen",storeName:"kidozen"});localforage.setItemAsync=function(c,a){var b=$.Deferred();localforage.setItem(c,a).then(function(a){setTimeout(function(){b.resolve(a)},50)},function(){b.reject()});return b.promise()};localforage.getItemAsync=function(c){var a=
$.Deferred();localforage.getItem(c).then(function(b){setTimeout(function(){a.resolve(b)},50)},function(){a.reject()});return a.promise()};localforage.removeItemAsync=function(c){var a=$.Deferred();localforage.removeItem(c).then(function(){setTimeout(function(){a.resolve()},50)});return a.promise()};this.collection=function(c){return new KidoLocalStorageCollection(c,this)}},KidoLocalStorageCollection=function(d,c){var a=this;if(!(this instanceof KidoLocalStorageCollection))return new KidoLocalStorageCollection(d,
c);if(!d)throw"KidoLocalStorageCollection needs a name to be created.";if(!c)throw"KidoLocalStorageCollection needs a parent KidoLocalStorage object.";this.localStorage=c;this.name="kido."+d;this.storeCollection=function(b){return localforage.setItemAsync(a.name,b)};this.insertItem=function(b){b._id=(-1*$.now()).toString();return a.query().then(function(c){c.push(b);return a.storeCollection(c).then(function(){return b})})};this.updateItem=function(b){return a.query().then(function(c){c||(c=[]);var d,
f;for(f=0;d=c[f];f++)if(d._id===b._id){c[f]=b;break}if(0!==c.length&&c.length===f)return a.localStorage.app.offline().getNewIdFromDictionary(b._id).then(function(c){b._id=c;return a.updateItem(b)},function(){c.push(b);return a.storeCollection(c).then(function(){return b})});0===c.length&&c.push(b);return a.storeCollection(c).then(function(){return b})})};this.persist=function(b){if(!b)throw"The 'new_val' argument is required in order to insert.";"object"!==typeof b&&(b=JSON.parse(b));return $.isArray(b)?
a.storeCollection(b):"undefined"!==typeof b._id?a.updateItem(b):a.insertItem(b)};this.get=function(b,c){if(!b)throw"The 'id' argument is required in order to get.";c||(c=!1);return a.query().then(function(d){for(var f,g=0;f=d[g];g++)if(f._id===b)return f;return c?$.Deferred().reject("Item not found"):a.localStorage.app.offline().getNewIdFromDictionary(b).then(function(b){return a.get(b,!0)})})};this.query=function(b){return localforage.getItemAsync(a.name).then(function(a){a||(a=[]);if("undefined"!==
typeof b)for(var c in b)a=$.map(a,function(a){return a[c]===b[c]?a:null});return a})};this.del=function(b){if(!b)throw"The 'id' argument is required in order to delete.";return a.query().then(function(c){c=$.map(c,function(a){return a._id!==b?a:null});return a.persist(c)})};this.drop=function(){return localforage.removeItemAsync(a.name)};this.length=function(){return a.query().then(function(a){return a.length})}};
Kido.prototype.localStorage=function(){this._localStorage||(this._localStorage=new KidoLocalStorage(this));return this._localStorage};var KidoOffline=function(d){if(!(this instanceof KidoOffline))return new KidoOffline(d);this.app=d;this.SERVICE_NAME="offline";var c=this,a=null,b=!1,e=c.app.localStorage().collection("id_dictionary",this),l=c.app.localStorage().collection("pending_requests",this),f=window.URL||window.webkitURL,g=window.Blob,m=window.Worker;this.startCheckingConnectivity=function(){if(!a)if(!c.app.isNative&&f&&g&&m){var b=new g(['var checkConnectivityInterval,checkConnectivityURL,checkConnectivityDelayTime;self.addEventListener("message",function(e){var t=e.data;switch(t.command){case"start":checkConnectivityURL=t.data.url,checkConnectivityDelayTime=t.data.delay,self.start();break;case"stop":self.stop()}},!1),self.stop=function(){clearInterval(checkConnectivityInterval),self.postMessage({event:"log",data:"Worker is stopped"}),self.postMessage({event:"stopped"}),self.close()},self.start=function(){self.postMessage({event:"log",data:"Worker is started"}),checkConnectivityInterval=setInterval(function(){self.doesConnectionExist()},checkConnectivityDelayTime)},self.doesConnectionExist=function(){self.postMessage({event:"log",data:"Worker is checking connection..."});var e=new XMLHttpRequest,t=Math.round(1e4*Math.random());e.open("HEAD",checkConnectivityURL+"?rand="+t,!1);try{e.send(),0!==e.status&&(self.postMessage({event:"log",data:"Worker detected connection :)"}),self.postMessage({event:"up"}))}catch(n){self.postMessage({event:"log",data:"Worker did not detect connection :("})}};']);
a=new m(f.createObjectURL(b));a.addEventListener("message",function(b){b=b.data;switch(b.event){case "up":c.executePendingRequests();a.postMessage({command:"stop"});break;case "stopped":a=null;break;case "log":console.log(b.data)}});a.postMessage({command:"start",data:{url:"http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js",delay:5E3}})}else a=setInterval(function(){console.log("Interval is checking connection...");var b=new XMLHttpRequest,d=Math.round(1E4*Math.random());b.open("HEAD",
"http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js?rand="+d,!1);try{b.send(),0!==b.status&&(console.log("Interval detected connection :)"),c.executePendingRequests(),clearInterval(a),a=null)}catch(e){console.log("Interval did not detect connection :(")}},5E3)};this.addPendingRequest=function(a,b){return l.persist({_id:a,request:b})};this.removePendingRequest=function(a){return l.del(a)};this.getPendingRequestObject=function(a){return l.get(a,!0).then(function(a){return JSON.parse(a.request.data)})};
this.executePendingRequests=function(){if(b)return $.Deferred().reject();b=!0;return l.query().then(function(a){return 0===a.length?(b=!1,$.Deferred().reject()):c.makeAjaxCall(a)}).then(function(){b=!1;return $.Deferred().resolve()},function(){b=!1;return $.Deferred().reject()})};this.makeAjaxCall=function(a){if(0===a.length)return $.Deferred().resolve();var b=a.shift();return $.ajax(b.request).then(function(d){return c.persistChange(b,d).then(function(){return l.persist(a)}).then(function(){return c.makeAjaxCall(a)})})};
this.persistChange=function(a,b){var d=c.app.localStorage().collection(a.request.kidoService.service+"."+a.request.kidoService.collection),f=a._id,g="object"===typeof b?b._id:null;return g?d.get(f,!0).then(function(a){a._id=g;return d.persist(a)},function(){return c.getPendingRequestObject(f).then(function(a){a._id=g;return d.persist(a)})}).then(function(){return f!==g?d.del(f).then(function(){return e.persist({_id:f,new_id:g})}):$.Deferred().resolve()},function(){return $.Deferred().resolve()}):
d.del(f).then(function(){return e.del(f)})};this.getNewIdFromDictionary=function(a){return e.get(a,!0).then(function(a){return a.new_id})};this.ajax=function(a){if(!a)throw"The 'settings' argument is required.";var b=a.data,d=a.kidoService.service,e=a.kidoService.collection,f=a.kidoService.objectId,g=a.kidoService.query,l=a.kidoService.caching,m=a.kidoService.queueing,n=a.type.toLowerCase(),s="get"===n&&f,v="get"===n&&!f,B="post"===n&&b,t="put"===n&&b,u="delete"===n&&f,w="delete"===n&&!f,n=$.ajax(a),
r=$.Deferred();if(l){var p=c.app.localStorage().collection(d+"."+e),q=b?JSON.parse(b):null,A=q?q._id:null,d=f&&0>parseInt(f)||A&&0>parseInt(A);if(s||v)a.timeout=5E3;if(d){if(s)return p.get(f);if(u)return p.del(f).then(function(){return c.removePendingRequest(f)});t&&(a.type="POST",delete q._id,a.data=JSON.stringify(q),f=null)}s||v?n.then(function(a){return p.persist(a)}):B||t?n.then(function(a){q._id=a._id?a._id:q._id?q._id:null;q._metadata=a._metadata?a._metadata:q._metadata?q._metadata:null;return p.persist(q)}):
u?n.then(function(){return p.del(f?f:A)}):w&&n.then(function(){return p.drop()})}n.fail(function(d){if(0!==d.status)return r.reject(d);c.startCheckingConnectivity();if(m&&!l)if(s||v)r.reject(d);else{var e=(-1*$.now()).toString();c.addPendingRequest(e,a).then(function(){r.reject(d)})}else l?(e=function(b){if(m&&(B||t||u||w)){var d=w?(-1*$.now()).toString():u?f:t?A:b._id;c.addPendingRequest(d,a).then(function(){r.resolve(b)})}else r.resolve(b)},v?p.query(g).then(e):s?p.get(f).then(e):B||t?p.persist(b).then(e):
u?p.del(f).then(e):w&&p.drop().then(e)):r.reject(d)});n.done(function(a){r.resolve(a)});return r.promise()}};Kido.prototype.offline=function(){this._offline||(this._offline=new KidoOffline(this));return this._offline};
